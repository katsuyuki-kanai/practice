# Webサーバーの仕組み（リクエスト・レスポンスの流れ）

## 1. Webサーバーとは

Webサーバーは、クライアント（ブラウザ）からのHTTPリクエストを受け取り、適切なレスポンスを返すソフトウェアです。

```
┌─────────────┐         HTTPリクエスト         ┌─────────────┐
│             │  ─────────────────────────────▶ │             │
│  クライアント  │                                │  Webサーバー  │
│  (ブラウザ)   │  ◀───────────────────────────── │             │
└─────────────┘         HTTPレスポンス         └─────────────┘
```

---

## 2. リクエスト・レスポンスの流れ

### 2.1 リクエストの処理フロー

```
ブラウザ                    Webサーバー                  アプリケーション
   │                           │                              │
   │  1. HTTPリクエスト送信      │                              │
   │  ─────────────────────▶   │                              │
   │                           │  2. リクエスト解析             │
   │                           │  ──────────────────────────▶  │
   │                           │                              │
   │                           │  3. ビジネスロジック実行       │
   │                           │  ◀──────────────────────────  │
   │                           │                              │
   │                           │  4. レスポンス生成             │
   │  5. HTTPレスポンス受信      │                              │
   │  ◀─────────────────────   │                              │
   │                           │                              │
   │  6. 画面描画               │                              │
```

### 2.2 サーバー内部での処理ステップ

1. **リクエスト受信**: クライアントからTCP接続を受け付ける
2. **リクエスト解析（パース）**: HTTPメソッド、URL、ヘッダー、ボディを解析
3. **ルーティング**: URLに対応する処理を決定
4. **ミドルウェア処理**: 認証、ログ、CORS処理など
5. **ハンドラー実行**: 実際のビジネスロジックを実行
6. **レスポンス生成**: HTML、JSON、ファイルなどを生成
7. **レスポンス送信**: クライアントにデータを返す

---

## 3. 2つのレンダリング方式

Webアプリケーションには、大きく分けて2つのレンダリング方式があります。

### 3.1 サーバーサイドレンダリング（SSR）

**概要**: サーバー側でHTMLを完成させてからクライアントに送信する方式

```
┌─────────────┐                     ┌─────────────┐                  ┌──────────┐
│  ブラウザ     │  1. ページリクエスト  │  Webサーバー  │  2. データ取得    │  データベース │
│             │  ──────────────────▶ │             │  ────────────▶  │          │
│             │                     │             │  ◀────────────  │          │
│             │                     │             │  3. データ返却    │          │
│             │  4. 完成したHTML返却   │             │                  │          │
│             │  ◀────────────────── │  (HTML生成)  │                  │          │
│             │                     │             │                  │          │
│  5. 画面表示  │                     │             │                  │          │
└─────────────┘                     └─────────────┘                  └──────────┘
```

**特徴**:
- ✅ 初期表示が速い（HTMLが完成した状態で届く）
- ✅ SEOに強い（検索エンジンがコンテンツを読み取りやすい）
- ✅ JavaScript無効でも基本的な表示が可能
- ❌ ページ遷移のたびにサーバーへリクエストが必要
- ❌ サーバーの負荷が高くなりやすい

**ユースケース**:
- ブログ、ニュースサイト
- ECサイトの商品ページ
- SEOが重要なサービス

---

### 3.2 クライアントサイドレンダリング（CSR）/ API方式

**概要**: 最初に空のHTMLとJavaScriptを送信し、ブラウザ側でAPIからデータを取得してUIを構築する方式

```
┌─────────────┐                     ┌─────────────┐                  ┌──────────┐
│  ブラウザ     │  1. ページリクエスト  │  Webサーバー  │                  │  データベース │
│             │  ──────────────────▶ │             │                  │          │
│             │  2. HTML+JS返却      │             │                  │          │
│             │  ◀────────────────── │             │                  │          │
│             │                     │             │                  │          │
│  3. JS実行   │  4. APIリクエスト    │             │  5. データ取得    │          │
│             │  ──────────────────▶ │             │  ────────────▶  │          │
│             │                     │             │  ◀────────────  │          │
│             │  6. JSONデータ返却   │             │  7. データ返却    │          │
│             │  ◀────────────────── │             │                  │          │
│             │                     │             │                  │          │
│  8. 画面描画  │                     │             │                  │          │
└─────────────┘                     └─────────────┘                  └──────────┘
```

**特徴**:
- ✅ ページ遷移が高速（必要なデータだけ取得）
- ✅ サーバー負荷が軽い（HTMLレンダリングをクライアントに委譲）
- ✅ リッチなユーザー体験（SPA: Single Page Application）
- ❌ 初期表示が遅い（JSの読み込み・実行が必要）
- ❌ SEOに弱い（JavaScriptを実行しないとコンテンツが見えない）

**ユースケース**:
- 管理画面、ダッシュボード
- チャットアプリ
- リアルタイム性が必要なサービス

---

### 3.3 比較表

| 観点 | SSR（サーバーサイド） | CSR（クライアントサイド） |
|------|---------------------|------------------------|
| 初期表示速度 | 速い | 遅い |
| ページ遷移 | 遅い（再読み込み） | 速い（部分更新） |
| SEO | 強い | 弱い |
| サーバー負荷 | 高い | 低い |
| UX | シンプル | リッチ |
| JavaScript依存 | 低い | 高い |

---

## 4. バックエンドのリクエスト処理詳細

### 4.1 Node.js/Expressの場合

```javascript
// リクエストの処理フロー
const express = require('express');
const app = express();

// ステップ1: ミドルウェアでリクエストを前処理
app.use(express.json());  // JSONボディのパース
app.use(express.static('public'));  // 静的ファイル配信

// ステップ2: ルーティングで適切なハンドラーに振り分け
app.get('/api/users', async (req, res) => {
    // ステップ3: ビジネスロジック実行
    const users = await database.getUsers();
    
    // ステップ4: レスポンス送信
    res.json(users);
});
```

### 4.2 リクエストオブジェクトの中身

```javascript
// req オブジェクトには以下の情報が含まれる
{
    method: 'GET',              // HTTPメソッド
    url: '/api/users?page=1',   // リクエストURL
    headers: {                   // HTTPヘッダー
        'content-type': 'application/json',
        'authorization': 'Bearer xxx'
    },
    query: { page: '1' },       // クエリパラメータ
    params: { id: '123' },      // URLパラメータ
    body: { name: 'John' }      // リクエストボディ
}
```

### 4.3 レスポンスオブジェクトの操作

```javascript
// res オブジェクトで以下の操作が可能
res.status(200);                    // ステータスコード設定
res.set('Content-Type', 'text/html'); // ヘッダー設定
res.json({ data: 'value' });        // JSON送信
res.send('<h1>Hello</h1>');         // HTML送信
res.sendFile('/path/to/file.pdf');  // ファイル送信
res.redirect('/other-page');        // リダイレクト
```

---

## 5. 実践：デモサーバーの実行

### 5.1 準備

```bash
# webServerディレクトリに移動
cd webServer

# 依存関係のインストール（初回のみ）
npm install
```

### 5.2 サーバー起動

```bash
node server.js
```

### 5.3 動作確認

ブラウザで以下のURLにアクセス：

| URL | 説明 | 方式 |
|-----|------|------|
| http://localhost:3000/ | トップページ | SSR |
| http://localhost:3000/ssr | SSRデモページ | SSR |
| http://localhost:3000/csr | CSRデモページ | CSR |
| http://localhost:3000/api/users | ユーザーAPI | JSON |

---

## 6. まとめ

1. **Webサーバーの役割**: HTTPリクエストを受け取り、適切なレスポンスを返す
2. **SSR**: サーバーでHTMLを生成 → SEOに強く、初期表示が速い
3. **CSR**: クライアントでHTMLを生成 → リッチなUX、ページ遷移が速い
4. **リクエスト処理**: パース → ルーティング → ハンドラー → レスポンス

現代のWebアプリケーションでは、SSRとCSRを組み合わせた**ハイブリッド方式**（Next.js、Nuxt.jsなど）も主流になっています。

---

## 7. 参考リンク

- [Node.js 公式ドキュメント](https://nodejs.org/docs/)
- [Express.js 公式ドキュメント](https://expressjs.com/)
- [MDN - HTTP の基本](https://developer.mozilla.org/ja/docs/Web/HTTP/Basics_of_HTTP)
