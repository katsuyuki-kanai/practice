# TLSの仕組み（HTTPS）

## 目次
1. [TLS/HTTPSとは](#tlshttpsとは)
2. [HTTPとHTTPSの違い](#httpとhttpsの違い)
3. [TLSの役割](#tlsの役割)
4. [暗号化の基本](#暗号化の基本)
5. [TLSハンドシェイク](#tlsハンドシェイク)
6. [証明書と認証局](#証明書と認証局)
7. [実際の通信フロー](#実際の通信フロー)
8. [まとめ](#まとめ)

---

## TLS/HTTPSとは

### HTTPS (HyperText Transfer Protocol Secure)
- HTTPに**セキュリティ機能**を追加したプロトコル
- Webサイトとブラウザ間の通信を**暗号化**する
- URLが `https://` で始まる

### TLS (Transport Layer Security)
- HTTPSで使われる**暗号化プロトコル**
- 以前はSSL (Secure Sockets Layer) と呼ばれていた
- 現在はTLS 1.2、TLS 1.3が主流

### なぜHTTPSが必要なのか？
通常のHTTP通信では、以下のような問題があります：

```
ブラウザ → [ユーザー名: admin] → サーバー
          [パスワード: pass123]
          ↑ この情報が丸見え！
```

**HTTPSがあれば：**
```
ブラウザ → [暗号化されたデータ] → サーバー
          ↑ 誰にも読めない！
```

---

## HTTPとHTTPSの違い

| 項目 | HTTP | HTTPS |
|-----|------|-------|
| 暗号化 | なし | あり |
| ポート番号 | 80 | 443 |
| 速度 | 速い | わずかに遅い（暗号化処理分） |
| セキュリティ | 低い | 高い |
| ブラウザ表示 | 警告あり | 🔒マーク |
| 証明書 | 不要 | 必要 |

---

## TLSの役割

TLSは3つの重要な役割を果たします：

### 1. 機密性（Confidentiality）
- データを**暗号化**して、第三者に読まれないようにする
- 例：パスワード、クレジットカード番号などを保護

### 2. 完全性（Integrity）
- データが**改ざんされていない**ことを保証
- 例：送信した内容が途中で書き換えられていないか検証

### 3. 認証（Authentication）
- 通信相手が**本物**であることを確認
- 例：偽のWebサイトではなく、本物のサイトと通信していることを証明

---

## 暗号化の基本

### 共通鍵暗号方式（対称鍵暗号）
- **同じ鍵**で暗号化と復号化を行う
- 高速だが、鍵の受け渡しが課題

```
送信者                     受信者
  |                          |
  |--[鍵で暗号化]----------→|
  |                    [同じ鍵で復号化]
  |                          |
問題: この鍵をどうやって安全に渡す？
```

**主なアルゴリズム：** AES、ChaCha20

### 公開鍵暗号方式（非対称鍵暗号）
- **公開鍵**と**秘密鍵**のペアを使用
- 公開鍵で暗号化 → 秘密鍵で復号化
- 低速だが、鍵の受け渡しが安全

```
受信者が鍵ペアを生成
├── 公開鍵（誰でも使える）
└── 秘密鍵（自分だけが持つ）

送信者
  |--[公開鍵で暗号化]------→ 受信者
                      [秘密鍵で復号化]
```

**主なアルゴリズム：** RSA、楕円曲線暗号（ECC）

### TLSではハイブリッド方式を使用
1. 公開鍵暗号で**共通鍵を安全に交換**
2. その後は**共通鍵暗号で高速通信**

---

## TLSハンドシェイク

実際の通信を始める前に、クライアントとサーバーが**安全な通信の準備**を行います。

### TLS 1.2のハンドシェイク（詳細版）

```
クライアント                          サーバー
    |                                    |
    |---(1) Client Hello--------------->|
    |    - TLSバージョン                  |
    |    - 対応している暗号スイート        |
    |    - ランダム値                     |
    |                                    |
    |<---(2) Server Hello----------------|
    |    - 選択したTLSバージョン          |
    |    - 選択した暗号スイート            |
    |    - ランダム値                     |
    |                                    |
    |<---(3) Certificate-----------------|
    |    - サーバーの証明書               |
    |                                    |
    |<---(4) Server Hello Done-----------|
    |                                    |
    |---(5) Client Key Exchange--------->|
    |    - 暗号化された共通鍵の材料        |
    |                                    |
    |---(6) Change Cipher Spec---------->|
    |    - これ以降は暗号化通信           |
    |                                    |
    |---(7) Finished-------------------->|
    |    - ハンドシェイクの検証データ      |
    |                                    |
    |<---(8) Change Cipher Spec----------|
    |                                    |
    |<---(9) Finished--------------------|
    |                                    |
    |========暗号化通信開始===============|
    |                                    |
    |<===(10) 暗号化されたHTTP通信=======>|
    |                                    |
```

### TLS 1.3のハンドシェイク（高速化）

TLS 1.3では、ハンドシェイクが**1往復**に短縮されました：

```
クライアント                          サーバー
    |                                    |
    |---(1) Client Hello--------------->|
    |    - 暗号鍵の材料も含む             |
    |                                    |
    |<---(2) Server Hello----------------|
    |    - 証明書                        |
    |    - 暗号鍵の材料                   |
    |    - Finished                      |
    |                                    |
    |===すぐに暗号化通信開始==============|
```

---

## 証明書と認証局

### SSL/TLS証明書とは？
Webサイトの**身分証明書**のようなもの。以下の情報が含まれます：

```
証明書の内容：
├── サイトのドメイン名（例: www.example.com）
├── 組織情報
├── 公開鍵
├── 発行者（認証局）
├── 有効期限
└── デジタル署名
```

### 認証局（CA: Certificate Authority）
証明書を発行する**信頼された第三者機関**

**主要な認証局：**
- Let's Encrypt（無料）
- DigiCert
- GlobalSign
- Comodo

### 証明書の検証フロー

```
1. ブラウザがサーバーから証明書を受け取る
   ↓
2. 証明書の有効期限をチェック
   ↓
3. ドメイン名が一致するかチェック
   ↓
4. 認証局のデジタル署名を検証
   ↓
5. 認証局が信頼できるかチェック
   （ブラウザに組み込まれた信頼リスト）
   ↓
6. すべてOKなら🔒マークを表示
```

### 証明書の種類

| 種類 | 検証レベル | 発行速度 | 用途 |
|-----|----------|---------|------|
| DV証明書 | ドメインのみ | 数分〜数時間 | 個人サイト、ブログ |
| OV証明書 | 組織まで検証 | 数日 | 企業サイト |
| EV証明書 | 厳格な検証 | 数週間 | 金融機関、大企業 |

---

## 実際の通信フロー

実際のHTTPS通信の全体像を見てみましょう。

### 例：https://www.example.com にアクセスする場合

```
【ステップ1】DNS解決
ブラウザ → DNSサーバー: www.example.comのIPアドレスは？
DNSサーバー → ブラウザ: 192.0.2.1 です

【ステップ2】TCP接続（3ウェイハンドシェイク）
ブラウザ → サーバー: SYN
サーバー → ブラウザ: SYN-ACK
ブラウザ → サーバー: ACK

【ステップ3】TLSハンドシェイク
ブラウザ ⇄ サーバー: 暗号化の準備（前述）

【ステップ4】HTTPリクエスト送信（暗号化）
ブラウザ → サーバー:
  GET / HTTP/1.1
  Host: www.example.com
  ...
  （すべて暗号化されている）

【ステップ5】HTTPレスポンス受信（暗号化）
サーバー → ブラウザ:
  HTTP/1.1 200 OK
  Content-Type: text/html
  ...
  <html>...</html>
  （すべて暗号化されている）

【ステップ6】復号化と表示
ブラウザが受信したデータを復号化してページを表示
```

### 実際の通信をキャプチャしたら？

**HTTP通信の場合：**
```
GET /login HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded

username=tanaka&password=secret123

→ パスワードが丸見え！
```

**HTTPS通信の場合：**
```
17 03 03 00 a8 3f 7e 92 c4 8b 2d f9 ... (暗号化されたバイナリデータ)

→ 何が送信されているか分からない！
```

---

## まとめ

### TLS/HTTPSの重要ポイント

✅ **HTTPSはHTTP + TLS** で安全な通信を実現

✅ **TLSの3つの役割**
   - 機密性（暗号化）
   - 完全性（改ざん検知）
   - 認証（なりすまし防止）

✅ **ハイブリッド暗号方式**
   - 公開鍵暗号で共通鍵を交換
   - 共通鍵暗号で高速な本通信

✅ **証明書で身元を保証**
   - 認証局が発行
   - ブラウザが検証

✅ **TLS 1.3で高速化**
   - ハンドシェイクが1往復に短縮
   - より強固な暗号化

### 開発時の注意点

1. **本番環境では必ずHTTPSを使用**
   - Let's Encryptで無料で証明書取得可能

2. **Mixed Content（混在コンテンツ）に注意**
   ```html
   <!-- HTTPSページ内で -->
   <img src="http://example.com/image.jpg"> <!-- NG -->
   <img src="https://example.com/image.jpg"> <!-- OK -->
   ```

3. **HSTSヘッダーで強制HTTPS化**
   ```
   Strict-Transport-Security: max-age=31536000; includeSubDomains
   ```

4. **証明書の有効期限管理**
   - Let's Encryptは90日で更新が必要
   - 自動更新の仕組みを構築

### さらに学ぶために

- **RFC 8446**: TLS 1.3の仕様
- **Mozilla SSL Configuration Generator**: Webサーバーの設定例
- **SSL Labs**: サイトのSSL/TLS設定をテスト（https://www.ssllabs.com/）
- **Wireshark**: パケットキャプチャツール（TLS通信を解析）

---

## 演習問題

### 問題1：基礎知識
次の文が正しいか間違っているか答えてください。

1. HTTPSではポート443を使用する（　　）
2. 公開鍵暗号は共通鍵暗号より高速である（　　）
3. TLS 1.3はTLS 1.2よりハンドシェイクが高速（　　）
4. Let's Encryptは有料の認証局である（　　）

### 問題2：シナリオ
あなたが開発したWebアプリケーションで、ユーザーのログイン情報を扱います。
HTTPとHTTPSのどちらを使うべきか、理由とともに説明してください。

### 問題3：実践
次のコマンドを実行して、実際のWebサイトの証明書を確認してみましょう：
```bash
# Windowsの場合（PowerShell）
$url = "https://www.google.com"
$req = [System.Net.WebRequest]::Create($url)
$req.GetResponse().Dispose()

# または、ブラウザで🔒マークをクリックして証明書の詳細を確認
```

---

**作成日**: 2026年2月4日  
**対象**: 新人エンジニア  
**所要時間**: 60分
